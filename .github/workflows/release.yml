name: Release Controller

on:
    workflow_dispatch:
        inputs:
            mode:
                description: "Run mode"
                required: true
                type: choice
                default: test
                options:
                    - test
                    - prerelease
                    - release

jobs:
    # ------------------------------------------------------------------
    # [Job 1] Setup: Calculate Version Tag
    # ------------------------------------------------------------------
    setup:
        name: Setup Metadata
        runs-on: ubuntu-latest
        outputs:
            release_tag: ${{ steps.get_tag.outputs.tag }}
            publish_release: ${{ steps.get_tag.outputs.publish_release }}
            prerelease: ${{ steps.get_tag.outputs.prerelease }}
            mode: ${{ steps.get_tag.outputs.mode }}
        steps:
            - name: Determine Tag
              id: get_tag
              shell: bash
              run: |
                  set -euo pipefail

                  MODE="${{ github.event.inputs.mode }}"
                  echo "mode=${MODE}" >> "$GITHUB_OUTPUT"

                  SHORT_SHA="${GITHUB_SHA::7}"
                  DATE_UTC="$(date -u +%Y%m%d)"

                  if [ "${MODE}" = "test" ]; then
                    # Test builds: no GitHub Release, only artifacts with a generated external tag.
                    echo "tag=dev-${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
                    echo "publish_release=false" >> "$GITHUB_OUTPUT"
                    echo "prerelease=false" >> "$GITHUB_OUTPUT"
                  elif [ "${MODE}" = "prerelease" ]; then
                    # Pre-release: create a GitHub Release marked as prerelease.
                    echo "tag=pre-${DATE_UTC}-${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
                    echo "publish_release=true" >> "$GITHUB_OUTPUT"
                    echo "prerelease=true" >> "$GITHUB_OUTPUT"
                  elif [ "${MODE}" = "release" ]; then
                    # Release: create a GitHub Release (not prerelease).
                    echo "tag=rel-${DATE_UTC}-${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
                    echo "publish_release=true" >> "$GITHUB_OUTPUT"
                    echo "prerelease=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "ERROR: unknown mode=${MODE}" >&2
                    exit 1
                  fi

    # ------------------------------------------------------------------
    # [Job 2] Call Native Build (Rust/Egui)
    # ------------------------------------------------------------------
    call-build-native:
        needs: setup
        uses: ./.github/workflows/build-native.yml
        with:
            release_tag: ${{ needs.setup.outputs.release_tag }}
            mode: ${{ needs.setup.outputs.mode }}
        secrets: inherit

    # ------------------------------------------------------------------
    # [Job 3] Call Flutter Build
    # ------------------------------------------------------------------
    call-build-flutter:
        needs: setup
        uses: ./.github/workflows/build-flutter.yml
        with:
            release_tag: ${{ needs.setup.outputs.release_tag }}
            mode: ${{ needs.setup.outputs.mode }}
        secrets: inherit

    # ------------------------------------------------------------------
    # [Job 4] Release: Publish to GitHub
    # ------------------------------------------------------------------
    create-release:
        name: Publish to GitHub Release
        if: ${{ needs.setup.outputs.publish_release == 'true' }}
        needs: [setup, call-build-native, call-build-flutter]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Publish Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.setup.outputs.release_tag }}
                  prerelease: ${{ needs.setup.outputs.prerelease == 'true' }}
                  generate_release_notes: true
                  files: |
                      # --- Nesium Egui (Native) ---
                      artifacts/**/nesium-egui-*.deb
                      artifacts/**/nesium-egui-*.msi
                      artifacts/**/nesium-egui-*.dmg
                      artifacts/**/nesium-egui-*.AppImage

                      # Fixed: Explicit extensions to avoid overlap with *.sha256
                      artifacts/**/nesium-egui-*-portable.zip
                      artifacts/**/nesium-egui-*-portable.tar.gz

                      # Matches ALL sha256 files (including portable ones)
                      artifacts/**/nesium-egui-*.sha256

                      # --- Nesium Libretro ---
                      artifacts/**/nesium-libretro-*.zip
                      artifacts/**/nesium-libretro-*.tar.gz
                      artifacts/**/nesium-libretro-*.sha256

                      # --- Nesium Flutter ---
                      artifacts/**/nesium-flutter-*.msi
                      artifacts/**/nesium-flutter-*.msi.sha256
                      artifacts/**/nesium-flutter-*.dmg
                      artifacts/**/nesium-flutter-*.dmg.sha256
                      artifacts/**/nesium-flutter-*-portable.zip
                      artifacts/**/nesium-flutter-*-portable.zip.sha256

                      artifacts/**/nesium-flutter-*.deb       
                      artifacts/**/nesium-flutter-*.deb.sha256 
                      artifacts/**/nesium-flutter-*-portable.tar.gz 
                      artifacts/**/nesium-flutter-*-portable.tar.gz.sha256

                      artifacts/**/nesium-flutter-*.apk
                      artifacts/**/nesium-flutter-*.apk.sha256
                      artifacts/**/nesium-flutter-*.aab
                      artifacts/**/nesium-flutter-*.aab.sha256
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
