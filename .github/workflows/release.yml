name: Release Controller

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag (e.g. v0.1.0)"
                required: true
                type: string

jobs:
    # ------------------------------------------------------------------
    # [Job 1] Setup: Calculate Version Tag
    # ------------------------------------------------------------------
    setup:
        name: Setup Metadata
        runs-on: ubuntu-latest
        outputs:
            release_tag: ${{ steps.get_tag.outputs.tag }}
        steps:
            - name: Determine Tag
              id: get_tag
              shell: bash
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
                  else
                    echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                  fi

    # ------------------------------------------------------------------
    # [Job 2] Call Native Build (Rust/Egui)
    # ------------------------------------------------------------------
    call-build-native:
        needs: setup
        uses: ./.github/workflows/build-native.yml
        with:
            release_tag: ${{ needs.setup.outputs.release_tag }}
        secrets: inherit

    # ------------------------------------------------------------------
    # [Job 3] Call Flutter Build
    # ------------------------------------------------------------------
    call-build-flutter:
        needs: setup
        uses: ./.github/workflows/build-flutter.yml
        with:
            release_tag: ${{ needs.setup.outputs.release_tag }}
        secrets: inherit

    # ------------------------------------------------------------------
    # [Job 4] Release: Publish to GitHub
    # ------------------------------------------------------------------
    create-release:
        name: Publish to GitHub Release
        needs: [setup, call-build-native, call-build-flutter]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Publish Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.setup.outputs.release_tag }}
                  prerelease: ${{ contains(needs.setup.outputs.release_tag, '-') }}
                  files: |
                      # --- Nesium Egui (Native) ---
                      artifacts/**/nesium-egui-*.deb
                      artifacts/**/nesium-egui-*.msi
                      artifacts/**/nesium-egui-*.dmg
                      artifacts/**/nesium-egui-*.AppImage

                      # Fixed: Explicit extensions to avoid overlap with *.sha256
                      artifacts/**/nesium-egui-*-portable.zip
                      artifacts/**/nesium-egui-*-portable.tar.gz

                      # Matches ALL sha256 files (including portable ones)
                      artifacts/**/nesium-egui-*.sha256

                      # --- Nesium Libretro ---
                      artifacts/**/nesium-libretro-*.zip
                      artifacts/**/nesium-libretro-*.tar.gz
                      artifacts/**/nesium-libretro-*.sha256

                      # --- Nesium Flutter ---
                      artifacts/**/nesium-flutter-*.msi
                      artifacts/**/nesium-flutter-*.msi.sha256
                      artifacts/**/nesium-flutter-*.dmg
                      artifacts/**/nesium-flutter-*.dmg.sha256
                      artifacts/**/nesium-flutter-*-portable.zip
                      artifacts/**/nesium-flutter-*-portable.zip.sha256
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
