name: Release Controller

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        type: choice
        default: test
        options:
          - test
          - prerelease
          - release

jobs:
  # ------------------------------------------------------------------
  # [Job 1] Setup: Calculate Version Tag
  # ------------------------------------------------------------------
  setup:
    name: Setup Metadata
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.get_tag.outputs.tag }}
      publish_release: ${{ steps.get_tag.outputs.publish_release }}
      prerelease: ${{ steps.get_tag.outputs.prerelease }}
      mode: ${{ steps.get_tag.outputs.mode }}
    steps:
      - name: Determine Tag
        id: get_tag
        shell: bash
        run: |
          set -euo pipefail

          MODE="${{ github.event.inputs.mode }}"
          echo "mode=${MODE}" >> "$GITHUB_OUTPUT"

          SHORT_SHA="${GITHUB_SHA::7}"
          DATE_UTC="$(date -u +%Y%m%d)"

          if [ "${MODE}" = "test" ]; then
            # Test builds: no GitHub Release, only artifacts with a generated external tag.
            echo "tag=dev-${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
            echo "publish_release=false" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          elif [ "${MODE}" = "prerelease" ]; then
            # Pre-release: create a GitHub Release marked as prerelease.
            echo "tag=pre-${DATE_UTC}-${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
            echo "publish_release=true" >> "$GITHUB_OUTPUT"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          elif [ "${MODE}" = "release" ]; then
            # Release: create a GitHub Release (not prerelease).
            echo "tag=rel-${DATE_UTC}-${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
            echo "publish_release=true" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: unknown mode=${MODE}" >&2
            exit 1
          fi

  # ------------------------------------------------------------------
  # [Job 2] Call Native Build (Rust/Egui)
  # ------------------------------------------------------------------
  call-build-native:
    needs: setup
    uses: ./.github/workflows/build-native.yml
    with:
      release_tag: ${{ needs.setup.outputs.release_tag }}
      mode: ${{ needs.setup.outputs.mode }}
    secrets: inherit

  # ------------------------------------------------------------------
  # [Job 3] Call Flutter Build
  # ------------------------------------------------------------------
  call-build-flutter:
    needs: setup
    uses: ./.github/workflows/build-flutter.yml
    with:
      release_tag: ${{ needs.setup.outputs.release_tag }}
      mode: ${{ needs.setup.outputs.mode }}
      is_check: false
    secrets: inherit

  # ------------------------------------------------------------------
  # [Job 4] Web: Build + Deploy to GitHub Pages
  # ------------------------------------------------------------------
  deploy-web-pages:
    name: Deploy Web (GitHub Pages)
    if: ${{ needs.setup.outputs.publish_release == 'true' || (needs.setup.outputs.mode == 'test' && github.ref_name == 'master') }}
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install Linux deps for nesium-icon
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y pkg-config libfreetype6-dev libfontconfig1-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Pub get
        working-directory: apps/nesium_flutter
        shell: bash
        run: flutter pub get

      - name: Install fonttools (Python)
        shell: bash
        run: |
          set -euo pipefail
          pip install fonttools

      - name: Subset fonts
        working-directory: apps/nesium_flutter
        shell: bash
        run: |
          set -euo pipefail
          python3 tool/subset_fonts.py

      - name: Generate icons (Rust + flutter_launcher_icons)
        shell: bash
        run: |
          set -euo pipefail
          ICON_DIR="apps/nesium_flutter/tool/generated/icons"
          mkdir -p "$ICON_DIR"
          cargo run -p nesium-icon -- --out "$ICON_DIR/app_icon_1024.png"
          cargo run -p nesium-icon -- layers \
            --bg "$ICON_DIR/app_icon_bg_1024.png" \
            --fg "$ICON_DIR/app_icon_fg_1024.png"
          (cd apps/nesium_flutter && dart run flutter_launcher_icons)

      - name: Build wasm (web runtime)
        shell: bash
        env:
          # Enable wasm SIMD for better runtime performance on modern browsers.
          # If you ever need a compatibility build, drop this flag.
          RUSTFLAGS: "-C target-feature=+simd128"
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"
          OUT_DIR="${GITHUB_WORKSPACE}/apps/nesium_flutter/web/nes/pkg"
          mkdir -p "${OUT_DIR}"

          pushd crates/nesium-wasm >/dev/null
          # Build with wasm-pack's default optimization.
          wasm-pack build --release --target web --out-dir "${OUT_DIR}"
          popd >/dev/null

      - name: Compute base href
        shell: bash
        run: |
          set -euo pipefail
          BASE_HREF="${{ vars.PAGES_BASE_HREF }}"
          if [ -z "${BASE_HREF}" ]; then
            BASE_HREF="/${{ github.event.repository.name }}/"
          fi
          case "${BASE_HREF}" in
            */) ;;
            *) BASE_HREF="${BASE_HREF}/" ;;
          esac
          echo "BASE_HREF=${BASE_HREF}" >> "$GITHUB_ENV"
          echo "Using BASE_HREF=${BASE_HREF}"

      - name: Build Flutter web
        working-directory: apps/nesium_flutter
        shell: bash
        run: flutter build web --release --wasm --base-href "${BASE_HREF}"

      - name: Verify web bundle assets
        shell: bash
        run: |
          set -euo pipefail
          test -f apps/nesium_flutter/build/web/nes/nes_worker.js
          test -f apps/nesium_flutter/build/web/nes/pkg/nesium_wasm.js
          test -f apps/nesium_flutter/build/web/nes/pkg/nesium_wasm_bg.wasm
          test -f apps/nesium_flutter/build/web/favicon.png
          test -f apps/nesium_flutter/build/web/manifest.json
          test -f apps/nesium_flutter/build/web/icons/Icon-192.png
          test -f apps/nesium_flutter/build/web/icons/Icon-512.png
          ls -la apps/nesium_flutter/build/web/nes/pkg
          ls -la apps/nesium_flutter/build/web/favicon.png apps/nesium_flutter/build/web/manifest.json
          sha256sum apps/nesium_flutter/build/web/favicon.png apps/nesium_flutter/build/web/manifest.json | cat

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/nesium_flutter/build/web

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ------------------------------------------------------------------
  # [Job 5] Release: Publish to GitHub
  # ------------------------------------------------------------------
  create-release:
    name: Publish to GitHub Release
    if: ${{ needs.setup.outputs.publish_release == 'true' }}
    needs: [setup, call-build-native, call-build-flutter]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute ASSET_TAG (from pubspec.yaml)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY' >> "$GITHUB_ENV"
          import re, pathlib, sys
          try:
              p = pathlib.Path('apps/nesium_flutter/pubspec.yaml')
              s = p.read_text(encoding='utf-8')
              m = re.search(r'^version:\s*([^\s]+)\s*$', s, re.M)
              if not m:
                  sys.exit('ERROR: version: not found in apps/nesium_flutter/pubspec.yaml')
              v = m.group(1)
              print(f'ASSET_TAG={v}')
          except Exception as e:
              sys.exit(f'ERROR: Script failed: {e}')
          PY

      - name: Generate Release Body
        shell: bash
        env:
          TAG: ${{ needs.setup.outputs.release_tag }}
        run: |
          set -euo pipefail
          cat > release_body.md <<EOF
          ### ðŸš€ Download Nesium (Flutter)
          
          | Platform | Download |
          | :--- | :--- |
          | **Android** | [![APK v8a](https://img.shields.io/badge/APK-arm64--v8a-green?style=for-the-badge&logo=android)](https://github.com/${{ github.repository }}/releases/download/${TAG}/nesium-flutter-${ASSET_TAG}-arm64-v8a.apk) [![APK Universal](https://img.shields.io/badge/APK-universal-green?style=for-the-badge&logo=android)](https://github.com/${{ github.repository }}/releases/download/${TAG}/nesium-flutter-${ASSET_TAG}-universal.apk) |
          | **Windows** | [![Setup x64](https://img.shields.io/badge/Setup-x86--64-blue?style=for-the-badge&logo=windows)](https://github.com/${{ github.repository }}/releases/download/${TAG}/nesium-flutter-${ASSET_TAG}-windows-x86_64-setup.zip) |
          | **macOS** | [![DMG Universal](https://img.shields.io/badge/DMG-universal-black?style=for-the-badge&logo=apple)](https://github.com/${{ github.repository }}/releases/download/${TAG}/nesium-flutter-${ASSET_TAG}-macos-universal.zip) |
          | **Linux** | [![tar.gz x64](https://img.shields.io/badge/tar.gz-x86--64-orange?style=for-the-badge&logo=linux)](https://github.com/${{ github.repository }}/releases/download/${TAG}/nesium-flutter-${ASSET_TAG}-linux-x86_64.tar.gz) [![tar.gz arm64](https://img.shields.io/badge/tar.gz-aarch64-orange?style=for-the-badge&logo=linux)](https://github.com/${{ github.repository }}/releases/download/${TAG}/nesium-flutter-${ASSET_TAG}-linux-aarch64.tar.gz) |
          
          EOF

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.release_tag }}
          prerelease: ${{ needs.setup.outputs.prerelease == 'true' }}
          generate_release_notes: true
          body_path: release_body.md
          files: |
            # --- Nesium Egui (Native) ---
            artifacts/**/nesium-egui-*.zip
            artifacts/**/nesium-egui-*.zip.sha256
            artifacts/**/nesium-egui-*.tar.gz
            artifacts/**/nesium-egui-*.tar.gz.sha256
            artifacts/**/nesium-egui-*.AppImage
            artifacts/**/nesium-egui-*.AppImage.sha256

            # --- Nesium Libretro (Consolidated) ---
            artifacts/nesium-libretro/nesium-libretro-*.zip
            artifacts/nesium-libretro/nesium-libretro-*.sha256

            # --- Nesium Flutter ---
            artifacts/**/nesium-flutter-*.apk
            artifacts/**/nesium-flutter-*.apk.sha256
            artifacts/**/nesium-flutter-*.zip
            artifacts/**/nesium-flutter-*.zip.sha256
            artifacts/**/nesium-flutter-*.tar.gz
            artifacts/**/nesium-flutter-*.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
