name: Reusable Flutter Build

on:
  workflow_call:
    inputs:
      release_tag:
        description: "The version tag for the release"
        required: true
        type: string
      mode:
        description: "Build mode: test | prerelease | release"
        required: true
        type: string

env:
  RELEASE_TAG: ${{ inputs.release_tag }}
  MODE: ${{ inputs.mode }}

jobs:
  build-flutter:
    name: Flutter ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64 Only
          - name: windows-x86_64-setup
            os: windows-latest
            target_arch: x64
            asset_ext: exe
            asset_suffix: windows-x86_64-setup

          # macOS Universal
          - name: macos-universal-dmg
            os: macos-latest
            asset_ext: dmg
            asset_suffix: macos-universal

          # Linux x86_64 (tar.gz)
          - name: linux-x86_64-tar
            os: ubuntu-latest
            asset_ext: tar.gz
            asset_suffix: linux-x86_64

          # Linux arm64 (tar.gz)
          - name: linux-aarch64-tar
            os: ubuntu-24.04-arm
            asset_ext: tar.gz
            asset_suffix: linux-aarch64

          # Android (APK + AAB)
          - name: android
            os: ubuntu-latest
            asset_suffix: android

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compute packaging/version vars
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"

          if [ "${MODE}" = "test" ]; then
            # Test builds: use externally-generated tag for file names
            echo "ASSET_TAG=${RELEASE_TAG}" >> "$GITHUB_ENV"
            echo "FLUTTER_BUILD_NAME=0.0.0" >> "$GITHUB_ENV"
            echo "FLUTTER_BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> "$GITHUB_ENV"
            echo "DEB_VERSION=0.0.0~dev.${GITHUB_RUN_NUMBER}+${SHORT_SHA}" >> "$GITHUB_ENV"
            echo "DEB_VERSION=0.0.0~dev.${GITHUB_RUN_NUMBER}+${SHORT_SHA}" >> "$GITHUB_ENV"
          else
            # Pre-release / Release: read Flutter version from pubspec.yaml
            python3 - <<'PY' >> "$GITHUB_ENV"
          import re, pathlib, sys
          try:
              p = pathlib.Path('apps/nesium_flutter/pubspec.yaml')
              s = p.read_text(encoding='utf-8')
              m = re.search(r'^version:\s*([^\s]+)\s*$', s, re.M)
              if not m:
                  sys.exit('ERROR: version: not found in apps/nesium_flutter/pubspec.yaml')
              v = m.group(1)
              if '+' in v:
                  name, build = v.split('+', 1)
              else:
                  name, build = v, '0'
              if not build.isdigit():
                  sys.exit(f'ERROR: pubspec build number must be digits, got: {build}')
              
              print(f'ASSET_TAG={v}')
              print(f'FLUTTER_BUILD_NAME={name}')
              print(f'FLUTTER_BUILD_NUMBER={build}')
              print(f'DEB_VERSION={v}')
          except Exception as e:
              sys.exit(f'ERROR: Script failed: {e}')
          PY
          fi

          echo "Using ASSET_TAG=${ASSET_TAG:-}" || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install Rust targets (Android)
        if: runner.os == 'Linux' && matrix.name == 'android'
        shell: bash
        run: |
          set -euo pipefail
          rustup target add \
            aarch64-linux-android \
            armv7-linux-androideabi \
            x86_64-linux-android

      - name: Setup MSVC env (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install Linux deps for nesium-icon
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y pkg-config libfreetype6-dev libfontconfig1-dev

      - name: Install Linux deps for Flutter Linux desktop
        if: runner.os == 'Linux' && startsWith(matrix.name, 'linux-')
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libasound2-dev \
            libudev-dev \
            dpkg-dev

      - name: Setup Flutter (official)
        if: ${{ !(runner.os == 'Linux' && matrix.asset_suffix == 'linux-aarch64') }}
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Flutter (Linux arm64 via git)
        if: ${{ runner.os == 'Linux' && matrix.asset_suffix == 'linux-aarch64' }}
        shell: bash
        run: |
          set -euo pipefail

          FLUTTER_DIR="$RUNNER_TEMP/flutter"
          rm -rf "$FLUTTER_DIR"
          git clone --depth 1 -b stable https://github.com/flutter/flutter.git "$FLUTTER_DIR"

          echo "$FLUTTER_DIR/bin" >> "$GITHUB_PATH"

          "$FLUTTER_DIR/bin/flutter" --version
          "$FLUTTER_DIR/bin/flutter" precache --linux
          "$FLUTTER_DIR/bin/flutter" doctor -v

      - name: Setup Java (Android)
        if: runner.os == 'Linux' && matrix.name == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK (Android)
        if: runner.os == 'Linux' && matrix.name == 'android'
        uses: android-actions/setup-android@v3

      - name: Install cargo-ndk (Android)
        if: runner.os == 'Linux' && matrix.name == 'android'
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-ndk --locked

      - name: Install Android NDK (Android)
        if: runner.os == 'Linux' && matrix.name == 'android'
        shell: bash
        run: |
          set -euo pipefail

          # Try finding sdkmanager
          SDKMANAGER="$(command -v sdkmanager || true)"
          if [ -z "${SDKMANAGER}" ]; then
            if [ -n "${ANDROID_SDK_ROOT:-}" ]; then
              SDKMANAGER="$(find "${ANDROID_SDK_ROOT}" -type f -name sdkmanager 2>/dev/null | head -n 1 || true)"
            fi
          fi
          if [ -z "${SDKMANAGER}" ] && [ -n "${ANDROID_HOME:-}" ]; then
            SDKMANAGER="$(find "${ANDROID_HOME}" -type f -name sdkmanager 2>/dev/null | head -n 1 || true)"
          fi
          if [ -z "${SDKMANAGER}" ]; then
            echo "ERROR: sdkmanager not found"
            exit 1
          fi

          echo "Using sdkmanager at: ${SDKMANAGER}"

          set +o pipefail
          yes | "${SDKMANAGER}" --install "ndk;26.1.10909125"
          SDK_RC=${PIPESTATUS[1]}
          set -o pipefail
          if [ "${SDK_RC}" -ne 0 ]; then
            echo "ERROR: sdkmanager failed with exit code ${SDK_RC}"
            exit "${SDK_RC}"
          fi
          "${SDKMANAGER}" --list_installed | grep -E "ndk;" || true

      - name: Flutter pub get
        working-directory: apps/nesium_flutter
        shell: bash
        run: |
          set -euo pipefail
          flutter --version
          flutter pub get

      - name: Generate shaders.zip
        working-directory: apps/nesium_flutter
        run: dart tool/package_shaders.dart

      - name: Install fonttools (Python)
        shell: bash
        run: |
          set -euo pipefail
          pip install fonttools

      - name: Subset fonts
        working-directory: apps/nesium_flutter
        shell: bash
        run: |
          set -euo pipefail
          python3 tool/subset_fonts.py

      - name: Generate icon PNGs (Rust) (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $IconDir = "apps/nesium_flutter/tool/generated/icons"
          New-Item -ItemType Directory -Force -Path $IconDir | Out-Null

          # Composite icon
          cargo run -p nesium-icon -- --out "$IconDir/app_icon_1024.png"

          # Layered icons
          cargo run -p nesium-icon -- layers `
            --bg "$IconDir/app_icon_bg_1024.png" `
            --fg "$IconDir/app_icon_fg_1024.png"
            
          Get-ChildItem -Path $IconDir

      - name: Generate icon PNGs (Rust) (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          ICON_DIR="apps/nesium_flutter/tool/generated/icons"
          mkdir -p "$ICON_DIR"

          cargo run -p nesium-icon -- --out "$ICON_DIR/app_icon_1024.png"

          cargo run -p nesium-icon -- layers \
            --bg "$ICON_DIR/app_icon_bg_1024.png" \
            --fg "$ICON_DIR/app_icon_fg_1024.png"
            
          ls -la "$ICON_DIR"

      - name: Update Flutter launcher icons (Windows)
        if: runner.os == 'Windows'
        working-directory: apps/nesium_flutter
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          dart run flutter_launcher_icons

      - name: Update Flutter launcher icons (macOS/Linux)
        if: runner.os != 'Windows'
        working-directory: apps/nesium_flutter
        shell: bash
        run: |
          set -euo pipefail
          dart run flutter_launcher_icons

      - name: Create dist directory
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

      # ===================================================
      # FLUTTER LINUX BUILD (TAR.GZ)
      # ===================================================
      - name: Build + package (Linux)
        if: runner.os == 'Linux' && startsWith(matrix.name, 'linux-')
        shell: bash
        run: |
          set -euo pipefail
          ROOT="${GITHUB_WORKSPACE}"
          DIST="$ROOT/dist"

          pushd "$ROOT/apps/nesium_flutter" >/dev/null
          flutter config --enable-linux-desktop
          flutter build linux --release --build-name "${FLUTTER_BUILD_NAME}" --build-number "${FLUTTER_BUILD_NUMBER}"

          BUNDLE_DIR="$(find build/linux -type d -path '*/release/bundle' | head -n 1 || true)"
          if [ -z "${BUNDLE_DIR}" ] || [ ! -d "${BUNDLE_DIR}" ]; then
            echo "ERROR: Linux bundle directory not found under apps/nesium_flutter/build/linux"
            find build/linux -maxdepth 4 -type d || true
            exit 1
          fi

          popd >/dev/null

          PKG_DIR="${RUNNER_TEMP}/nesium-linux-pkg"
          rm -rf "${PKG_DIR}"
          mkdir -p "${PKG_DIR}/Nesium"

          # Bundle contents
          cp -R "${ROOT}/apps/nesium_flutter/${BUNDLE_DIR}/"* "${PKG_DIR}/Nesium/"

          # Optional docs
          if [ -f "${ROOT}/README.md" ]; then cp -f "${ROOT}/README.md" "${PKG_DIR}/Nesium/"; fi
          if [ -f "${ROOT}/LICENSE.md" ]; then cp -f "${ROOT}/LICENSE.md" "${PKG_DIR}/Nesium/"; fi

          # Installable package (.deb)
          DEB_ARCH="amd64"
          if [ "${{ matrix.asset_suffix }}" = "linux-aarch64" ]; then
            DEB_ARCH="arm64"
          fi

          DEB_ROOT="${RUNNER_TEMP}/nesium-deb"
          rm -rf "${DEB_ROOT}"
          mkdir -p "${DEB_ROOT}/DEBIAN"
          mkdir -p "${DEB_ROOT}/opt/nesium"
          mkdir -p "${DEB_ROOT}/usr/bin"
          mkdir -p "${DEB_ROOT}/usr/share/applications"

          cp -R "${PKG_DIR}/Nesium" "${DEB_ROOT}/opt/nesium/"
          cat > "${DEB_ROOT}/usr/bin/nesium" <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          exec /opt/nesium/Nesium/Nesium "$@"
          SH
          chmod +x "${DEB_ROOT}/usr/bin/nesium"

          # Desktop entry
          cat > "${DEB_ROOT}/usr/share/applications/nesium.desktop" <<'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=Nesium
          Exec=nesium
          Terminal=false
          Categories=Game;
          DESKTOP

          # Minimal control file
          cat > "${DEB_ROOT}/DEBIAN/control" <<CONTROL
          Package: nesium
          Version: ${DEB_VERSION}
          Section: games
          Priority: optional
          Architecture: ${DEB_ARCH}
          Maintainer: Nesium
          Description: Nesium (Flutter)
          CONTROL

          OUT_DEB="${RUNNER_TEMP}/nesium-flutter-${ASSET_TAG}-${{ matrix.asset_suffix }}.deb"
          dpkg-deb --build "${DEB_ROOT}" "${OUT_DEB}"

          # Consolidate into a single distribution archive
          CONSOLIDATED_DIR="${RUNNER_TEMP}/nesium-linux-full"
          rm -rf "${CONSOLIDATED_DIR}"
          mkdir -p "${CONSOLIDATED_DIR}"
          
          # 1. Add Portable version
          cp -R "${PKG_DIR}/Nesium" "${CONSOLIDATED_DIR}/portable"
          
          # 2. Add DEB package
          cp "${OUT_DEB}" "${CONSOLIDATED_DIR}/"
          
          # Create final archive
          OUT_FINAL="${DIST}/nesium-flutter-${ASSET_TAG}-${{ matrix.asset_suffix }}.tar.gz"
          tar -C "${CONSOLIDATED_DIR}" -czf "${OUT_FINAL}" .
          (cd "$DIST" && shasum -a 256 "$(basename "$OUT_FINAL")" > "$(basename "$OUT_FINAL").sha256")

          ls -la "$DIST"

      # ===================================================
      # FLUTTER ANDROID BUILD (APK)
      # ===================================================
      - name: Build + package (Android)
        if: runner.os == 'Linux' && matrix.name == 'android'
        shell: bash
        run: |
          set -euo pipefail
          ROOT="${GITHUB_WORKSPACE}"
          DIST="$ROOT/dist"

          pushd "$ROOT/apps/nesium_flutter" >/dev/null

          # Decode Keystore and create key.properties if secrets are available
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "Decoding Keystore..."
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks
            
            echo "Creating key.properties..."
            echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
            echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
            echo "storeFile=upload-keystore.jks" >> android/key.properties
          else
            echo "Warning: ANDROID_KEYSTORE_BASE64 secret is not set. Skipping release signing configuration."
          fi

          # 1. Build Universal APK (FAT)
          flutter build apk --release --build-name "${FLUTTER_BUILD_NAME}" --build-number "${FLUTTER_BUILD_NUMBER}"
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/nesium-universal.apk

          # 2. Build ARM64 APK (Optimized for modern devices)
          flutter build apk --release --build-name "${FLUTTER_BUILD_NAME}" --build-number "${FLUTTER_BUILD_NUMBER}" --target-platform android-arm64
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/nesium-arm64.apk

          popd >/dev/null

          APK_UNIVERSAL="$ROOT/apps/nesium_flutter/build/app/outputs/flutter-apk/nesium-universal.apk"
          APK_ARM64="$ROOT/apps/nesium_flutter/build/app/outputs/flutter-apk/nesium-arm64.apk"

          if [ ! -f "$APK_UNIVERSAL" ] || [ ! -f "$APK_ARM64" ]; then
            echo "ERROR: One or more Android artifacts missing"
            ls -R "$ROOT/apps/nesium_flutter/build/app/outputs/"
            exit 1
          fi

          # Consolidate Android artifacts into a single ZIP
          ANDROID_BUNDLE_DIR="${RUNNER_TEMP}/nesium-android-bundle"
          rm -rf "${ANDROID_BUNDLE_DIR}"
          mkdir -p "${ANDROID_BUNDLE_DIR}"
          
          cp -f "$APK_ARM64" "${ANDROID_BUNDLE_DIR}/nesium-flutter-${ASSET_TAG}-arm64-v8a.apk"
          cp -f "$APK_UNIVERSAL" "${ANDROID_BUNDLE_DIR}/nesium-flutter-${ASSET_TAG}-universal.apk"
          
          OUT_ZIP="${DIST}/nesium-flutter-${ASSET_TAG}-${{ matrix.asset_suffix }}.zip"
          (cd "${ANDROID_BUNDLE_DIR}" && zip -r "${OUT_ZIP}" .)
          (cd "$DIST" && shasum -a 256 "$(basename "$OUT_ZIP")" > "$(basename "$OUT_ZIP").sha256")

          # Also copy individual APKs to dist for direct release links
          cp -f "$APK_ARM64" "${DIST}/nesium-flutter-${ASSET_TAG}-arm64-v8a.apk"
          cp -f "$APK_UNIVERSAL" "${DIST}/nesium-flutter-${ASSET_TAG}-universal.apk"
          (cd "$DIST" && shasum -a 256 "nesium-flutter-${ASSET_TAG}-arm64-v8a.apk" > "nesium-flutter-${ASSET_TAG}-arm64-v8a.apk.sha256")
          (cd "$DIST" && shasum -a 256 "nesium-flutter-${ASSET_TAG}-universal.apk" > "nesium-flutter-${ASSET_TAG}-universal.apk.sha256")

          ls -la "$DIST"

      - name: Install Inno Setup (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install innosetup -y

      # ===================================================
      # FLUTTER WINDOWS BUILD & INNO SETUP & PORTABLE
      # ===================================================
      - name: Build + package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # 1. Build (Standard x64)
          Push-Location "apps\nesium_flutter"
          flutter config --enable-windows-desktop
          flutter build windows --release --build-name "$env:FLUTTER_BUILD_NAME" --build-number "$env:FLUTTER_BUILD_NUMBER"
          Pop-Location

          # 2. Locate Artifacts
          $src = Join-Path $env:GITHUB_WORKSPACE "apps\nesium_flutter\build\windows\x64\runner\Release"
          if (-not (Test-Path $src)) {
              $src = Join-Path $env:GITHUB_WORKSPACE "apps\nesium_flutter\build\windows\runner\Release"
          }
          if (-not (Test-Path $src)) {
              $exe = Get-ChildItem -Path "apps\nesium_flutter\build\windows" -Recurse -Filter "Nesium.exe" | Select-Object -First 1
              if ($exe) { $src = $exe.DirectoryName }
          }
          if (-not (Test-Path $src)) {
            Write-Error "Build output directory not found!"
          }

          Write-Host "Artifacts located at: $src"

          # 3. Prepare Portable Directory
          $portableDir = Join-Path $env:RUNNER_TEMP "nesium-windows-portable"
          if (Test-Path $portableDir) { Remove-Item -Recurse -Force $portableDir }
          New-Item -ItemType Directory -Force -Path $portableDir | Out-Null
          Copy-Item -Path (Join-Path $src "*") -Destination $portableDir -Recurse -Force
          if (Test-Path (Join-Path $env:GITHUB_WORKSPACE "README.md")) { Copy-Item (Join-Path $env:GITHUB_WORKSPACE "README.md") $portableDir -Force }
          if (Test-Path (Join-Path $env:GITHUB_WORKSPACE "LICENSE.md")) { Copy-Item (Join-Path $env:GITHUB_WORKSPACE "LICENSE.md") $portableDir -Force }

          # 4. Create Inno Setup Installer
          $outSetup = "nesium-setup-$env:ASSET_TAG.exe"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DMyAppVersion="$env:ASSET_TAG" `
            /DSourceDir="$src" `
            /O"$env:RUNNER_TEMP" `
            /F"nesium-setup-$env:ASSET_TAG" `
            "apps\nesium_flutter\windows\installer.iss"

          $finalSetupPath = Join-Path $env:RUNNER_TEMP $outSetup

          # 5. Code Signing
          if ("${{ secrets.WINDOWS_CERT_PFX_BASE64 }}" -ne "") {
            $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String("${{ secrets.WINDOWS_CERT_PFX_BASE64 }}"))
            
            # Sign the main executable in the build folder
            $exe = Get-ChildItem -Path $src -Filter *.exe | Select-Object -First 1
            if ($exe) { & signtool sign /f $pfxPath /p "${{ secrets.WINDOWS_CERT_PASSWORD }}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 $exe.FullName }
            
            # Sign the Setup installer
            & signtool sign /f $pfxPath /p "${{ secrets.WINDOWS_CERT_PASSWORD }}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 $finalSetupPath
          }

          # 6. Consolidation
          $consolidatedDir = Join-Path $env:RUNNER_TEMP "nesium-windows-full"
          if (Test-Path $consolidatedDir) { Remove-Item -Recurse -Force $consolidatedDir }
          New-Item -ItemType Directory -Force -Path $consolidatedDir | Out-Null
          
          # Add Portable version
          Copy-Item -Path $portableDir -Destination (Join-Path $consolidatedDir "portable") -Recurse -Force
          
          # Add Setup EXE
          Copy-Item -Path $finalSetupPath -Destination $consolidatedDir -Force
          
          # Create Final ZIP
          $finalZip = "nesium-flutter-$env:ASSET_TAG-${{ matrix.asset_suffix }}.zip"
          Compress-Archive -Path "$consolidatedDir\*" -DestinationPath (Join-Path $env:GITHUB_WORKSPACE "dist\$finalZip") -Force

          # 7. Checksums
          Push-Location "dist"
          Get-FileHash "$finalZip" -Algorithm SHA256 | ForEach-Object { "$($_.Hash.ToLower())  $($_.Path.Split('\')[-1])" } | Out-File -Encoding ascii "$finalZip.sha256"
          Pop-Location

          Get-ChildItem -Path "$env:GITHUB_WORKSPACE/dist" | Format-Table -AutoSize

      # ===================================================
      # FLUTTER MACOS BUILD & FIX & DMG & PORTABLE
      # ===================================================
      - name: Build + package (macOS universal)
        if: runner.os == 'macOS'
        shell: bash
        working-directory: apps/nesium_flutter
        run: |
          set -euo pipefail
          rustup target add aarch64-apple-darwin x86_64-apple-darwin || true

          # 1. Build Flutter App
          flutter config --enable-macos-desktop
          flutter build macos --release --build-name "${FLUTTER_BUILD_NAME}" --build-number "${FLUTTER_BUILD_NUMBER}"

          ROOT="${GITHUB_WORKSPACE}"
          DIST="$ROOT/dist"

          app_src="$(ls -d build/macos/Build/Products/Release/*.app | head -n 1)"
          if [ -z "${app_src}" ]; then
              echo "No .app produced under build/macos/Build/Products/Release"
              exit 1
          fi
          app_name_ext="$(basename "$app_src")"
          app_bin_name="${app_name_ext%.*}"

          echo "Found App: $app_src (Binary: $app_bin_name)"

          # [STEP 2] Manually Build & Embed Rust Dylib
          echo "ðŸ”§ Starting manual Rust dylib injection..."
          pushd "${ROOT}"
          cargo build -p nesium-flutter --lib --release --target aarch64-apple-darwin
          cargo build -p nesium-flutter --lib --release --target x86_64-apple-darwin
          popd

          FRAMEWORKS_DIR="$app_src/Contents/Frameworks"
          mkdir -p "$FRAMEWORKS_DIR"

          DYLIB_NAME="libnesium_flutter.dylib"
          SRC_ARM="${ROOT}/target/aarch64-apple-darwin/release/$DYLIB_NAME"
          SRC_X86="${ROOT}/target/x86_64-apple-darwin/release/$DYLIB_NAME"
          DEST_DYLIB="$FRAMEWORKS_DIR/$DYLIB_NAME"

          if [ -f "$SRC_ARM" ] && [ -f "$SRC_X86" ]; then
              echo "Merging architectures into universal dylib..."
              lipo -create "$SRC_ARM" "$SRC_X86" -output "$DEST_DYLIB"
          else
              echo "Error: Rust dylibs not found in target directory!"
              exit 1
          fi

          # [STEP 3] FIX PATHS (Core Fix for Universal Binary)
          echo "ðŸ”§ Patching paths..."

          # A. Fix Dylib ID (install name)
          install_name_tool -id "@rpath/$DYLIB_NAME" "$DEST_DYLIB"

          # B. Fix Main Executable
          EXEC_PATH="$app_src/Contents/MacOS/$app_bin_name"

          # Ensure the executable can resolve @rpath from Contents/Frameworks
          if ! otool -l "$EXEC_PATH" | grep -A2 LC_RPATH | grep -q "@executable_path/../Frameworks"; then
            echo "Adding rpath @executable_path/../Frameworks to executable..."
            install_name_tool -add_rpath "@executable_path/../Frameworks" "$EXEC_PATH" 2>/dev/null || true
          fi

          patch_slice() {
            local arch="$1"
            echo "Patching $arch slice dependency for $DYLIB_NAME..."

            local old_path
            old_path=$(otool -arch "$arch" -L "$EXEC_PATH" | awk -v lib="$DYLIB_NAME" '$1 ~ lib {print $1; exit}')
            old_path=$(echo "${old_path:-}" | xargs)

            if [ -z "$old_path" ]; then
              echo "Warning: No $DYLIB_NAME reference found in $arch slice."
              return 0
            fi

            echo "Detected $arch OLD_PATH: '$old_path'"

            if [ "$old_path" != "@rpath/$DYLIB_NAME" ]; then
              echo "Performing $arch patch: '$old_path' -> '@rpath/$DYLIB_NAME'"
              install_name_tool -change "$old_path" "@rpath/$DYLIB_NAME" "$EXEC_PATH"
            else
              echo "$arch slice already uses @rpath/$DYLIB_NAME"
            fi
          }

          # Patch both slices (universal executable)
          patch_slice arm64
          patch_slice x86_64

          # [STEP 4] Packaging
          rm -rf "$ROOT/dmg-src" "$DIST/portable"
          mkdir -p "$ROOT/dmg-src" "$DIST/portable"

          cp -R "$app_src" "$ROOT/dmg-src/"

          # [STEP 4.1] Ad-hoc Code Signing
          echo "Signing application (ad-hoc)..."
          APP_DMG="$ROOT/dmg-src/$app_name_ext"
          BIN_DMG="$APP_DMG/Contents/MacOS/$app_bin_name"
          FW_DIR="$APP_DMG/Contents/Frameworks"
          PLUGINS_DIR="$APP_DMG/Contents/PlugIns"

          ENTITLEMENTS="$ROOT/nesium.entitlements"

          cat > "$ENTITLEMENTS" <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>com.apple.security.app-sandbox</key>
            <true/>
            <key>com.apple.security.files.user-selected.read-write</key>
            <true/>
          </dict>
          </plist>
          PLIST

          sign_macho() {
            local p="$1"
            if [ -f "$p" ] && file -b "$p" | grep -q "Mach-O"; then
              codesign --force --sign - "$p"
            fi
          }

          # 1) Sign nested code
          if [ -d "$FW_DIR" ]; then
            echo "Signing embedded dylibs..."
            while IFS= read -r -d '' f; do
              sign_macho "$f"
            done < <(find "$FW_DIR" -type f -name "*.dylib" -print0)

            echo "Signing embedded framework binaries..."
            while IFS= read -r -d '' f; do
              sign_macho "$f"
            done < <(find "$FW_DIR" -type f -path "*.framework/Versions/A/*" -print0)
          fi

          if [ -d "$PLUGINS_DIR" ]; then
            echo "Signing embedded plugins/extensions (PlugIns)..."
            while IFS= read -r -d '' f; do
              sign_macho "$f"
            done < <(find "$PLUGINS_DIR" -type f -print0)
          fi

          # 2) Sign main executable
          echo "Signing main executable..."
          if [ -f "$BIN_DMG" ] && file -b "$BIN_DMG" | grep -q "Mach-O"; then
            codesign --force --sign - --entitlements "$ENTITLEMENTS" "$BIN_DMG"
          fi

          # 3) Sign bundle wrapper
          echo "Signing app bundle wrapper..."
          codesign --force --sign - --entitlements "$ENTITLEMENTS" "$APP_DMG"

          codesign --verify --deep --strict --verbose=2 "$APP_DMG" || true

          ln -s /Applications "$ROOT/dmg-src/Applications"

          dmg_rw="${RUNNER_TEMP}/nesium-flutter-${ASSET_TAG}-${{ matrix.asset_suffix }}-rw.dmg"
          dmg="${RUNNER_TEMP}/nesium-flutter-${ASSET_TAG}-${{ matrix.asset_suffix }}.${{ matrix.asset_ext }}"
          vol="Nesium"

          hdiutil create -volname "$vol" -srcfolder "$ROOT/dmg-src" -ov -format UDRW "$dmg_rw"
          hdiutil convert "$dmg_rw" -format UDZO -o "$dmg"
          rm -f "$dmg_rw"

          # [STEP 5] Consolidation
          CONSOLIDATED_DIR="${RUNNER_TEMP}/nesium-macos-full"
          rm -rf "${CONSOLIDATED_DIR}"
          mkdir -p "${CONSOLIDATED_DIR}"
          
          # Add Portable version (App bundle)
          cp -R "$ROOT/dmg-src/$app_name_ext" "${CONSOLIDATED_DIR}/portable/"
          cp "$ROOT/README.md" "$ROOT/LICENSE.md" "${CONSOLIDATED_DIR}/portable/" 2>/dev/null || true
          
          # Add DMG
          cp "$dmg" "${CONSOLIDATED_DIR}/"
          
          # Create Final ZIP
          OUT_FINAL="${DIST}/nesium-flutter-${ASSET_TAG}-${{ matrix.asset_suffix }}.zip"
          (cd "${CONSOLIDATED_DIR}" && zip -r "${OUT_FINAL}" .)
          (cd "$DIST" && shasum -a 256 "$(basename "$OUT_FINAL")" > "$(basename "$OUT_FINAL").sha256")

          ls -la "$DIST"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nesium-flutter-${{ matrix.name }}
          path: dist/*
          if-no-files-found: ignore
